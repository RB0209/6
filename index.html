<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stories of Six Lives — Portrait Morph (Accessible • Optimized)</title>

  <!-- NOTE: CDN Tailwind is fine for demos. For production, install Tailwind via PostCSS/CLI. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Inline favicon to avoid 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="1"><stop stop-color="%2369339c"/><stop offset="1" stop-color="%23fde047"/></linearGradient></defs><rect width="64" height="64" rx="12" fill="url(%23g)"/><text x="32" y="40" text-anchor="middle" font-size="28" font-family="Arial" fill="white">6</text></svg>'/>

  <style>
    :root{
      --primary:#69339c;
      --accent:#fde047;
      --bg:#060607;
      --card:#0d0d0d;
    }
    html,body{height:100%}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system,"Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg); color:#fff; margin:0; overflow-x:hidden;
    }

    /* STARFIELD */
    .starfield{position:fixed; inset:0; pointer-events:none; z-index:0}
    .vignette:before{content:""; position:fixed; inset:0; pointer-events:none; box-shadow: inset 0 0 220px rgba(0,0,0,.7)}

    /* INTRO */
    .intro-gradient{
      background:
        radial-gradient(1200px 600px at 50% 40%, rgba(253,224,71,0.12), transparent 60%),
        radial-gradient(900px 600px at 70% 70%, rgba(105,51,156,0.25), transparent 60%),
        #000;
    }
    .intro-title{letter-spacing:.08em; filter: drop-shadow(0 10px 30px rgba(253,224,71,.25))}
    @media (prefers-reduced-motion:no-preference){
      @keyframes titleIn{0%{opacity:0; transform: translateY(24px) scale(1.06)}60%{opacity:1}100%{transform:translateY(0) scale(1)}}
      .animate-titleIn{animation:titleIn 1.2s ease both}
    }

    /* ROW LAYOUT */
    .char-row{display:flex; gap:1rem; align-items:center; max-width:1100px; margin:1.4rem auto; padding:0 1rem; position:relative; z-index:1}
    .portrait{
      flex:0 0 170px; aspect-ratio:2/3; border-radius:1rem; position:relative; overflow:hidden;
      background:var(--card); box-shadow:0 20px 60px rgba(0,0,0,.6);
      transition: transform .28s cubic-bezier(.2,.9,.2,1), box-shadow .28s ease, opacity .28s ease, filter .28s ease;
      cursor:pointer; border:1px solid rgba(255,255,255,.06);
    }
    .portrait:focus{outline:2px solid var(--accent); outline-offset:2px}
    .portrait:hover{transform: translateY(-6px) scale(1.02); box-shadow:0 30px 90px rgba(0,0,0,.7)}
    .portrait .fill{position:absolute; inset:0; background: linear-gradient(180deg, rgba(255,255,255,.02), transparent)}
    .portrait .accent{position:absolute; inset:0; background: linear-gradient(135deg, var(--tile), rgba(253,224,71,.25)); mix-blend-mode: overlay; opacity:.12}
    .portrait h3{position:absolute; left:1rem; bottom:1rem; right:1rem; font-size:1rem; font-weight:800; line-height:1.15; margin:0}
    .portrait.focused{transform: translateY(-6px) scale(.99); filter:brightness(.98)}

    /* PREVIEW PANEL */
    .chap-panel{flex:1; min-height:220px; display:flex; align-items:center; justify-content:center; position:relative; transition:opacity .25s ease, transform .25s ease}
    .chap-panel.closed{opacity:0; transform: translateX(12px); pointer-events:none}
    .chap-frame{
      width: clamp(380px, calc(100% - 220px), 720px);
      border-radius:1rem; padding:1.25rem;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06);
      box-shadow: 0 30px 80px rgba(0,0,0,.6);
      position:relative; overflow:hidden;
    }
    .preview-head{display:flex; justify-content:space-between; align-items:flex-start; gap:.75rem}
    .preview-title{font-size:1.2rem; font-weight:800; margin:0}
    .preview-teaser{color:#e6d98f; margin-top:.25rem; font-size:.95rem; max-width:60ch; line-height:1.25}
    .preview-episodes{display:flex; gap:.6rem; margin-top:.9rem; padding-bottom:.6rem; overflow:auto; scroll-behavior:smooth}
    .ep-card{flex:0 0 220px; border-radius:.75rem; padding:.7rem; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); transition: transform .2s ease, box-shadow .2s ease}
    .ep-card:hover{transform: translateY(-4px); box-shadow:0 18px 48px rgba(0,0,0,.55)}
    .ep-title{font-weight:700; margin:0}
    .scroll-hint:after{
      content:""; position:absolute; right:0; top:0; bottom:0; width:48px;
      background:linear-gradient(90deg, transparent, rgba(6,6,7,.9));
      pointer-events:none;
    }

    /* MORPH CLONE */
    .morph-clone{
      position:fixed; z-index:60; border-radius:1rem; overflow:hidden; background:var(--card);
      box-shadow:0 40px 120px rgba(0,0,0,.6);
      transition: transform .45s cubic-bezier(.22,1,.36,1), opacity .2s; transform-origin: top left;
      will-change: transform;
    }

    /* READER (modal) */
    .reader{position:fixed; inset:0; z-index:70; display:none; background:linear-gradient(180deg, rgba(5,5,7,.9), rgba(8,8,12,.98))}
    .reader.active{display:block}
    .reader .screen{
      max-width:940px; margin:4.5vh auto 6vh;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.06); border-radius:1rem;
      box-shadow:0 40px 120px rgba(0,0,0,.75); overflow:hidden;
    }
    .reader-head{display:flex; justify-content:space-between; align-items:center; padding:1rem; background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.25)); border-bottom:1px solid rgba(255,255,255,.04)}
    .reader-article{--rs:1; font-size:calc(1.02rem * var(--rs)); line-height:1.85; padding:2rem 2rem 3rem; color:#e9eefc}
    .reader-article h1{font-size:1.7rem; margin:0 0 .65rem}
    .reader-article p{font-size:1rem; margin:0 0 1rem}
    .reader-article p:first-letter{font-size:2.6rem; float:left; line-height:1; margin-right:.35rem; color:var(--accent); font-weight:800}
    .reader-meta{color:#a9b2c7; font-size:.95rem; margin-bottom:.8rem}
    .reader-controls{display:flex; gap:.5rem; align-items:center}
    .progress{position:fixed; left:0; right:0; bottom:0; height:6px; background:rgba(255,255,255,.06)}
    .progress>span{display:block; height:100%; width:0; background: linear-gradient(90deg, var(--primary), var(--accent))}
    .btn{display:inline-flex; align-items:center; gap:.5rem; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); padding:.5rem .75rem; border-radius:.65rem}
    .btn:focus{outline:2px solid var(--accent); outline-offset:2px}

    /* RESPONSIVE */
    @media (max-width:920px){ .chap-frame{width:calc(100% - 20px)} .char-row{padding:0 .75rem} }
    @media (max-width:800px){
      .char-row{flex-direction:column; align-items:stretch}
      .portrait{margin:0 auto; width:48%; aspect-ratio:2/3}
      .chap-panel{min-height:260px}
      .chap-frame{width:100%}
      .morph-clone{transition: transform .4s cubic-bezier(.22,1,.36,1), opacity .2s}
    }
    @media (max-width:480px){ .portrait{width:64%} }

    .text-accent{color:#f8e36c}
  </style>
</head>
<body>
  <canvas id="starsBack" class="starfield"></canvas>
  <canvas id="starsFront" class="starfield"></canvas>
  <div class="vignette"></div>

  <!-- INTRO -->
  <section id="intro" class="intro-gradient fixed inset-0 flex flex-col items-center justify-center text-center z-20" aria-labelledby="introTitle">
    <div class="px-6">
      <h1 id="introTitle" class="intro-title text-4xl md:text-6xl font-extrabold animate-titleIn">
        Stories of <span class="text-accent">Six</span> Lives
      </h1>
      <p class="mt-4 text-sm md:text-lg text-gray-300">Six souls. Six timelines. One universe.</p>
      <div class="mt-6 flex gap-3 justify-center">
        <button id="enter" type="button" class="btn" aria-describedby="introHelp">Enter</button>
        <button id="skipIntro" type="button" class="btn">Skip intro</button>
      </div>
      <p id="introHelp" class="mt-2 text-xs text-gray-400">Press Enter or click to continue</p>
    </div>
  </section>

  <!-- HUB -->
  <main id="hub" class="hub pt-24 pb-20" hidden aria-live="polite">
    <header class="max-w-[1100px] mx-auto px-4 pb-4 flex justify-between items-center text-accent">
      <h2 class="text-2xl font-semibold">Characters</h2>
      <div class="text-sm text-gray-400">Dark • Cinematic</div>
    </header>
    <div id="rows"></div>
  </main>

  <!-- READER (modal) -->
  <section id="reader" class="reader" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="readerTitle">
    <div class="screen">
      <div class="reader-head">
        <div class="flex items-center gap-2">
          <button id="readerExit" type="button" class="btn" aria-label="Close reader">Exit</button>
          <div id="readerLabel" class="font-bold"></div>
        </div>
        <div class="reader-controls">
          <button id="readerPrev" type="button" class="btn" aria-label="Previous chapter">Prev</button>
          <button id="readerNext" type="button" class="btn" aria-label="Next chapter">Next</button>
        </div>
      </div>
      <article class="reader-article">
        <h1 id="readerTitle"></h1>
        <div id="readerMeta" class="reader-meta"></div>
        <div id="readerBody"></div>
      </article>
    </div>
    <div class="progress"><span id="prog"></span></div>

    <div id="readerControls" class="fixed left-1/2 -translate-x-1/2 bottom-3 z-20 flex gap-2">
      <button id="sm" type="button" class="btn" aria-label="Small font">A-</button>
      <button id="md" type="button" class="btn" aria-label="Medium font">A</button>
      <button id="lg" type="button" class="btn" aria-label="Large font">A+</button>
    </div>
  </section>

  <script>
  "use strict";

  /* ========= UTIL ========= */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function debounce(fn, wait=200){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
  }

  /* ========= STARFIELD (optimized) ========= */
  (function starfield(){
    const S1 = document.getElementById('starsBack'), S2 = document.getElementById('starsFront');
    const DPR = Math.min(window.devicePixelRatio || 1, 2);

    function setup(c){
      c.width = innerWidth * DPR; c.height = innerHeight * DPR;
      const ctx = c.getContext('2d'); ctx.scale(DPR, DPR); return ctx;
    }
    let ctx1 = setup(S1), ctx2 = setup(S2);

    const st1 = [], st2 = [];
    function make(arr, n, speed, radiusMin=0.2, radiusVar=1.6){
      arr.length=0;
      for(let i=0;i<n;i++){
        arr.push({
          x: Math.random()*innerWidth,
          y: Math.random()*innerHeight,
          r: Math.random()*radiusVar + radiusMin,
          s: speed * (0.6 + Math.random()),
          a: 0.35 + Math.random()*0.4
        });
      }
    }
    make(st1, 90, 0.10);
    make(st2, 45, 0.22);

    let ox=0, oy=0, vx=0, vy=0;
    function draw(ctx, arr, mx, my){
      ctx.clearRect(0,0,innerWidth,innerHeight);
      ctx.fillStyle='#fff';
      for(const p of arr){
        let x = (p.x + mx * p.s) % (innerWidth + 50); if(x < -50) x += innerWidth + 50;
        let y = (p.y + my * p.s) % (innerHeight + 50); if(y < -50) y += innerHeight + 50;
        ctx.globalAlpha = p.a;
        ctx.beginPath(); ctx.arc(x,y,p.r,0,Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    function anim(){
      ox += vx; oy += vy; vx *= .96; vy *= .96;
      draw(ctx1, st1, ox, oy);
      draw(ctx2, st2, ox*1.35, oy*1.35);
      requestAnimationFrame(anim);
    }
    if(!prefersReduced){ anim(); }

    addEventListener('mousemove', e=>{
      const cx = innerWidth/2, cy = innerHeight/2;
      vx += (e.clientX - cx)/-30000;
      vy += (e.clientY - cy)/-30000;
    }, {passive:true});

    addEventListener('resize', debounce(()=>{
      ctx1 = setup(S1); ctx2 = setup(S2);
      make(st1, 90, 0.10); make(st2, 45, 0.22);
      if(prefersReduced){
        draw(ctx1, st1, 0, 0); draw(ctx2, st2, 0, 0);
      }
    }, 100));

    if(prefersReduced){
      draw(ctx1, st1, 0, 0); draw(ctx2, st2, 0, 0);
    }
  })();

  /* ========= INTRO ========= */
  const intro = document.getElementById('intro');
  const hub = document.getElementById('hub');
  const enter = document.getElementById('enter');
  const skipBtn = document.getElementById('skipIntro');

  function revealHub(){
    // Prevent double-run
    if (intro.style.display === 'none') return;

    intro.style.display='none';
    hub.hidden=false;
    hub.style.opacity='0';
    hub.style.transition='opacity .35s ease';
    requestAnimationFrame(()=> hub.style.opacity='1');

    // move focus to first portrait for accessibility
    setTimeout(()=>{
      const firstPortrait = document.querySelector('.portrait');
      if (firstPortrait) firstPortrait.focus();
    }, 60);
  }

  enter.addEventListener('click', revealHub);
  skipBtn.addEventListener('click', revealHub);

  // Allow Enter from anywhere while intro visible
  addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && intro.style.display !== 'none'){
      e.preventDefault();
      revealHub();
    }
  });

  /* ========= DATA ========= */
  const data = {
    1:{ name:'Selah — The Quiet Storm', color:'#8b5cf6',
      teaser:'On a crowded Dubai Metro, a lost card and a devastating message set Selah on a path she never expected.',
      chapters:[{ title:'Please mind the gap between the train and the platform.',
        body:`"Doors opening"
A swarm of female passengers gushed into the women’s compartment of the Dubai Metro. Crushed by the crowd, Selah spotted a small space near the divider between the general and women’s compartments, a shaky spot to stand but enough room to breathe. She quickly rushed towards it, but a blank-faced woman carrying two tote bags full of monthly supplies took the spot first. The flow of the crowd pushed Selah back into the middle.
With slight annoyance on her face, she somehow managed to pull her Bluetooth earphones out of her blazer pocket and listened to songs she had downloaded three years ago. As the music played, she zoned out from the misery of her long journey back to her rented room after a job she hated.
Looking out of the window, her thoughts were barely coherent because one of her insecurities was her height, and the tall woman in front of her was wearing a broad-brimmed sunhat, blocking much of her view.
"Same bed but it feels just a little bigger now," Bruno Mars sang softly in her ears. The melody was calm and soothing, but within seconds a radish was shoved up her nose because the woman with the sunhat had chosen to eat it for lunch.
Selah felt a gagging, nauseous sensation. It was as if her life was slipping through her fingers. Just then, a sudden jerk of the train pushed everyone to the right, and Selah felt relieved as the radish wind shifted away. She noticed a lady nearby covering her nose with a hand fan. Selah smiled, trying not to laugh.
Throughout the journey, she had felt the discomfort and frustration of not having luxurious resources. Selah had made a lot of bad decisions, one of the worst was now calling her. She answered, saying, "Hello? What is it?"
Zain, her ex, replied from the other end, "I found the ATM card you lost a month ago. Oh, and before I forget, I withdrew 100,000 but don't worry, I’ve left 500 rupees for you to spend."
Selah quickly checked her notifications and saw two transactions of 50,000 rupees each had gone through. Filled with rage and tears, she told him to return the money, but the call ended. When she tried calling back, there was no response.
Selah had no one to turn to. First, she was living three hours away by flight from her hometown, Mumbai. Second, Zain was the guilty secret she hid from her family. She could only rely on her friend, but recently, she had refused to lend her friend money for a family crisis.
Shame and guilt overtook her thoughts just as she heard the bell and the intercom announce, "Next station: Mall of the Emirates. Doors opening…"
Selah, still reeling from the loss of her savings, tried to think of someone, anyone, who might help her. The crowded metro from that day still lingered in her mind, the press of strangers, the blur of faces, and somewhere among those memories was an old college friend, Prithvi.
Prithvi once had a major crush on her, which she had rejected without remorse. She knew it, and so did he. But now, necessity outweighed pride. He was part of the police force in Mumbai, someone who could pull strings quietly, without her family knowing.
She called him. Her words tumbled out quickly, just like an eel slipping through your hands above water, but his replies were flat and emotionless. He brushed her off without even a sandgrain’s size of care. Selah was hurt and broken; her last strand of hope made her feel regret about the past choices she had made. Selah thought to herself, I should have been a bit kinder when I rejected him. A year’s worth of savings was gone. A year’s worth of skipped treats, less shopping, and extra hours at work. It felt as if the metro’s clattering wheels from that day were still carrying her further away from what she had lost.
She told herself to move on, but pain does not vanish on command.
Weeks later, Selah was lying on her bed, looking at the ceiling, fighting against the mattress to let her free. With zero will, she grabbed her phone and turned off DND mode, trying to think of an excuse to skip office. As notifications from unwanted apps flooded in, she read a message from her neighbour: Your brother has been attacked by a mob. He’s gone.
The world seemed to tilt. Her eyes grew heavy and her vision blurred. She had no money to make the journey home. The coins she had once guarded so fiercely had already gone. She grabbed her bag and knocked on her boss’s cabin door.
With trembling hands and a heavy throat, she went to her boss, hoping for compassion. He lent her only enough to cover a return ticket, nothing more. It would get her there and back, but not spare her family from the crushing expense of a burial. She had no time to grieve, no time to think of her twenty-three-year-old little brother, whom she had helped with school homework, fought for snacks with, whose T-shirt she had stolen all while also asking him for IT support.
When she finally landed back in Mumbai, the heat and bustle of the city hit her like a wave. The familiar streets felt both comforting and unbearably heavy, reminding her of all that had been lost. 
Meera, her dearest friend, hearing the news that Selah was back, rushed to pick her up at the airport. With tears in her eyes, she hugged her because Simon’s loss was tough for them both. Selah knowing that grief had met poverty in an unwanted truce had nothing but worry on her face. She was from a middle-class household already stretched thin, struggling to lay her brother Simon to rest with dignity. On the way home, when Meera heard the news about Selah’s savings, without a second thought, she offered the money Selah needed from her bonus she had received for her hard work at work. Selah accepted, not only for the help but for the kindness it carried.` }]}
    },
    2:{ name:'Maya — The Fighter', color:'#f472b6', teaser:'Quick teaser...', chapters:[{title:'Ch.1: Southbound', body:'The train moaned into motion...'}]},
    3:{ name:'Rehan — The Observer', color:'#60a5fa', teaser:'Quick teaser...', chapters:[{title:'Ch.1: The Quiet Corner', body:'He collected glances like stamps...'}]},
    4:{ name:'Zara — The Wanderer', color:'#34d399', teaser:'Quick teaser...', chapters:[{title:'Ch.1: Lost Maps', body:'Roads loosened from the atlas...'}]},
    5:{ name:'Kabir — The Seeker', color:'#fde047', teaser:'Quick teaser...', chapters:[{title:'Ch.1: Lanterns', body:'Between alleys, a patient light...'}]},
    6:{ name:'Ishaan — The Hidden', color:'#f87171', teaser:'Quick teaser...', chapters:[{title:'Ch.1: Under the Radar', body:'In the noise, the safest place was quiet...'}]},
  };

  /* ========= BUILD ROWS ========= */
  const rowsContainer = document.getElementById('rows');

  Object.keys(data).forEach(id=>{
    const d = data[id];
    const row = document.createElement('section');
    row.className = 'char-row'; row.dataset.char = id;

    // Portrait button
    const p = document.createElement('button');
    p.className = 'portrait';
    p.dataset.char = id;
    p.setAttribute('aria-expanded','false');
    p.style.setProperty('--tile', d.color);
    p.innerHTML = `
      <span class="accent" style="background:linear-gradient(135deg, ${d.color}, rgba(253,224,71,.25));opacity:.12"></span>
      <span class="fill"></span>
      <h3>${d.name}</h3>
    `;

    // Panel
    const panel = document.createElement('div');
    panel.className = 'chap-panel closed';
    panel.dataset.char = id;

    const frame = document.createElement('div');
    frame.className = 'chap-frame';
    frame.innerHTML = `
      <div class="preview-head">
        <div>
          <h3 class="preview-title"></h3>
          <div class="preview-teaser"></div>
        </div>
        <div class="flex gap-2 items-center">
          <button class="btn open-full" type="button">Read</button>
          <button class="btn close-panel" type="button" aria-label="Close preview">Close</button>
        </div>
      </div>
      <div class="preview-episodes relative scroll-hint" aria-label="Episode list"></div>
    `;

    panel.appendChild(frame);
    row.appendChild(p);
    row.appendChild(panel);
    rowsContainer.appendChild(row);

    // state
    let idx = 0;

    function render(){
      const chap = (data[id].chapters && data[id].chapters[idx]) || {title:'Coming soon', body:''};
      frame.querySelector('.preview-title').textContent = chap.title;
      const teaserEl = frame.querySelector('.preview-teaser');
      teaserEl.textContent = d.teaser || '';
      teaserEl.style.opacity = d.teaser ? '1' : '0.7';

      const epRow = frame.querySelector('.preview-episodes');
      epRow.innerHTML = '';
      (data[id].chapters || []).forEach((c,i)=>{
        const ep = document.createElement('button');
        ep.className = 'ep-card';
        ep.type = 'button';
        ep.setAttribute('aria-label', `Open ${c.title}`);
        ep.innerHTML = `<p class="ep-title">${c.title}</p>`;
        ep.addEventListener('click', ()=>{ idx=i; render(); openReader(parseInt(id,10), idx); });
        epRow.appendChild(ep);
      });
    }

    // MORPH open
    let morphing = false;
    function openPanel(){
      if(morphing || panel.dataset.open === 'true') return;
      morphing = true;

      // close others
      $$('.chap-panel').forEach(cp=>{
        if(cp!==panel){
          cp.classList.add('closed');
          cp.dataset.open='false';
          const otherP = cp.parentElement.querySelector('.portrait');
          if (otherP){
            otherP.classList.remove('focused');
            otherP.setAttribute('aria-expanded','false');
          }
        }
      });

      if (prefersReduced) {
        render();
        panel.classList.remove('closed');
        panel.dataset.open='true';
        p.classList.add('focused');
        p.setAttribute('aria-expanded','true');
        morphing=false;
        return;
      }

      panel.classList.remove('closed'); panel.dataset.open='opening';
      requestAnimationFrame(()=>{
        const srcRect = p.getBoundingClientRect();
        const tgtRect = frame.getBoundingClientRect();

        const clone = p.cloneNode(true);
        clone.classList.add('morph-clone');
        Object.assign(clone.style, {left:srcRect.left+'px', top:srcRect.top+'px', width:srcRect.width+'px', height:srcRect.height+'px', transform:'none'});
        document.body.appendChild(clone);

        const dx = tgtRect.left - srcRect.left;
        const dy = tgtRect.top - srcRect.top;
        const sx = tgtRect.width / srcRect.width;
        const sy = tgtRect.height / srcRect.height;

        requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(${sx}, ${sy})`; });

        clone.addEventListener('transitionend', function onEnd(){
          clone.removeEventListener('transitionend', onEnd);
          clone.style.opacity='0';
          setTimeout(()=> clone.remove(), 100);
          frame.style.opacity='0'; frame.style.transition='opacity .22s ease';
          setTimeout(()=>{
            render();
            frame.style.opacity='1';
            panel.dataset.open='true';
            p.classList.add('focused');
            p.setAttribute('aria-expanded','true');
            morphing=false;
          }, 110);
        }, {once:true});
      });
    }
    function closePanel(){
      if(panel.classList.contains('closed')) return;

      if (prefersReduced) {
        panel.classList.add('closed'); panel.dataset.open='false';
        p.classList.remove('focused'); p.setAttribute('aria-expanded','false');
        return;
      }

      const srcRect = frame.getBoundingClientRect();
      const tgtRect = p.getBoundingClientRect();

      const clone = frame.cloneNode(true);
      Object.assign(clone.style,{position:'fixed', left:srcRect.left+'px', top:srcRect.top+'px', width:srcRect.width+'px', height:srcRect.height+'px'});
      clone.classList.add('morph-clone');
      document.body.appendChild(clone);

      panel.classList.add('closed'); panel.dataset.open='false';
      p.classList.remove('focused'); p.setAttribute('aria-expanded','false');

      const dx = tgtRect.left - srcRect.left;
      const dy = tgtRect.top - srcRect.top;
      const sx = tgtRect.width / srcRect.width;
      const sy = tgtRect.height / srcRect.height;

      requestAnimationFrame(()=>{ clone.style.transform = `translate(${dx}px, ${dy}px) scale(${sx}, ${sy})`; });
      clone.addEventListener('transitionend', ()=>{ clone.style.opacity='0'; setTimeout(()=>clone.remove(), 90); }, {once:true});
    }

    // events
    p.addEventListener('click', openPanel);
    p.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openPanel(); }});

    frame.querySelector('.open-full').addEventListener('click', ()=> openReader(parseInt(id,10), idx));
    frame.querySelector('.close-panel').addEventListener('click', closePanel);

    // outside click closes only if panel open
    function outside(e){
      if(panel.dataset.open==='true' && !row.contains(e.target)){ closePanel(); }
    }
    document.addEventListener('pointerdown', outside);

    // init closed
    panel.classList.add('closed');
  });

  /* ========= READER (modal with focus trap) ========= */
  const reader = document.getElementById('reader');
  const readerTitle = document.getElementById('readerTitle');
  const readerBody = document.getElementById('readerBody');
  const readerLabel = document.getElementById('readerLabel');
  const prog = document.getElementById('prog');
  const readerExit = document.getElementById('readerExit');
  const readerPrev = document.getElementById('readerPrev');
  const readerNext = document.getElementById('readerNext');

  let currentChar = 1, currentIdx = 0;
  let lastFocused = null;

  const setRS = (v)=>{ document.querySelector('.reader-article').style.setProperty('--rs', v); };
  const savedRS = parseFloat(localStorage.getItem('readerRS') || '1');
  setRS(savedRS);

  function onReaderKeydown(e){
    if(!reader.classList.contains('active')) return;
    if(e.key==='ArrowRight') readerNext.click();
    if(e.key==='ArrowLeft') readerPrev.click();
    if(e.key==='Escape') readerExit.click();
    if(e.key==='Tab'){ maintainFocusTrap(e); }
  }

  function openReader(charId, idx){
    currentChar = charId; currentIdx = idx;
    reader.classList.add('active');
    reader.setAttribute('aria-hidden','false');
    document.documentElement.style.overflow='hidden';
    lastFocused = document.activeElement;
    renderReader();
    trapFocusStart();
    addEventListener('keydown', onReaderKeydown);
  }
  function closeReader(){
    reader.classList.remove('active');
    reader.setAttribute('aria-hidden','true');
    document.documentElement.style.overflow='';
    releaseFocusTrap();
    removeEventListener('keydown', onReaderKeydown);
    if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
  }

  function renderReader(){
    const d = data[currentChar];
    const c = d.chapters[currentIdx] || {title:'', body:''};
    readerTitle.textContent = c.title || '—';
    document.getElementById('readerMeta').textContent = d.teaser || '';
    readerLabel.textContent = d.name || '';

    // Safe body rendering (preserves paragraphs)
    readerBody.innerHTML = '';
    const paragraphs = String(c.body || '').split(/\n{2,}/);
    for(const seg of paragraphs){
      const p = document.createElement('p');
      p.textContent = seg.replace(/\n/g, ' ');
      readerBody.appendChild(p);
    }

    const pct = ((currentIdx+1)/(d.chapters.length || 1))*100;
    prog.style.width = pct + '%';
    saveProgress();

    // focus first control
    readerExit.focus();

    // refresh focusables when content changes
    trapFocusStart(true);
  }
  const saveProgress = debounce(()=>{ try{ localStorage.setItem('char'+currentChar, data[currentChar].chapters[currentIdx]?.title || ''); }catch{} }, 150);

  readerExit.addEventListener('click', closeReader);
  readerPrev.addEventListener('click', ()=>{ if(currentIdx>0){ currentIdx--; renderReader(); }});
  readerNext.addEventListener('click', ()=>{ if(currentIdx < (data[currentChar].chapters.length-1)){ currentIdx++; renderReader(); }});

  // backdrop click to exit
  reader.addEventListener('click', (e)=>{ if(e.target === reader) closeReader(); });

  // Font size persistence
  document.getElementById('sm').addEventListener('click', ()=>{ setRS(.9); localStorage.setItem('readerRS', .9); });
  document.getElementById('md').addEventListener('click', ()=>{ setRS(1); localStorage.setItem('readerRS', 1); });
  document.getElementById('lg').addEventListener('click', ()=>{ setRS(1.15); localStorage.setItem('readerRS', 1.15); });

  /* ========= Focus Trap Helpers ========= */
  let focusables = []; let firstF=null, lastF=null;
  function trapFocusStart(refreshOnly=false){
    focusables = $$(
      '#reader button, #reader [href], #reader input, #reader select, #reader textarea, #reader [tabindex]:not([tabindex="-1"])'
    ).filter(el=> !el.hasAttribute('disabled') && !el.getAttribute('aria-hidden'));
    firstF = focusables[0]; lastF = focusables[focusables.length-1];
    if(!refreshOnly){ firstF?.focus(); }
  }
  function maintainFocusTrap(e){
    if(focusables.length===0) return;
    if(e.shiftKey && document.activeElement === firstF){ e.preventDefault(); lastF.focus(); }
    else if(!e.shiftKey && document.activeElement === lastF){ e.preventDefault(); firstF.focus(); }
  }
  function releaseFocusTrap(){ focusables=[]; firstF=null; lastF=null; }

  // Quiet placeholder retained: load progress badges (no-op if elements not present)
  (function loadProgress(){
    for(let i=1;i<=6;i++){
      try{
        const val = localStorage.getItem('char'+i) || '';
        const el = document.querySelector('.cont-'+i);
        if(el) el.textContent = val ? val : '—';
      }catch{}
    }
  })();
  </script>
</body>
</html>
